#pragma once

#include <array>
#include <cstddef>
#include <cstdint>
#include <expected>
#include <filesystem>
#include <string>

class CPU {
private:
    static constexpr size_t s_display_width = 64;
    static constexpr size_t s_display_height = 32;

    static constexpr size_t s_font_size = 80;
    static constexpr size_t s_start_address = 0x200;

    static constexpr std::array<uint8_t, s_font_size> s_font_set = {
        0xF0, 0x90, 0x90, 0x90, 0xF0, 0x20, 0x60, 0x20, 0x20, 0x70, 0xF0, 0x10, 0xF0, 0x80, 0xF0, 0xF0, 0x10, 0xF0, 0x10, 0xF0,
        0x90, 0x90, 0xF0, 0x10, 0x10, 0xF0, 0x80, 0xF0, 0x10, 0xF0, 0xF0, 0x80, 0xF0, 0x90, 0xF0, 0xF0, 0x10, 0x20, 0x40, 0x40,
        0xF0, 0x90, 0xF0, 0x90, 0xF0, 0xF0, 0x90, 0xF0, 0x10, 0xF0, 0xF0, 0x90, 0xF0, 0x90, 0x90, 0xE0, 0x90, 0xE0, 0x90, 0xE0,
        0xF0, 0x80, 0x80, 0x80, 0xF0, 0xE0, 0x90, 0x90, 0x90, 0xE0, 0xF0, 0x80, 0xF0, 0x80, 0xF0, 0xF0, 0x80, 0xF0, 0x80, 0x80};

public:
    CPU();

    std::expected<void, std::string> load_rom(const std::filesystem::path* rom_path);
    void step();

private:
    struct State {
        std::array<uint8_t, 4096> memory{};
        std::array<bool, s_display_width * s_display_height> display{};
        std::array<uint16_t, 16> stack{};
        std::array<uint8_t, 16> v{};
        uint16_t pc = s_start_address;
        uint8_t i{};
        uint8_t sp{};
        uint8_t delay_timer{};
        uint8_t sound_timer{};
    };

    State m_state;
};
